<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="~{fragments/header::fragment-header}"></div>
</head>
<body>
<div th:replace="~{fragments/nav::fragment-nav}"></div>
<div class="content">
    <div class="container mt-3">
        <h1>회원정보 수정</h1>
        <hr/>

        <form id="frm">
            <div class="mb-3">
                <label for="loginId" class="form-label">ID</label>
                <input type="text" class="form-control" id="loginId" th:value="${session.loginId}" name="loginId" placeholder="사용할 아이디를 입력하세요." readonly />
            </div>

            <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="이름을 입력하세요."/>
            </div>

            <div class="mb-3">
                <label for="loginId" class="form-label">Password</label>
                <input type="password" class="form-control" id="new-password" name="new-password" placeholder="비밀번호를 입력하세요."/>
            </div>

            <div class="mb-3">
                <label for="loginId" class="form-label">Check Password</label>
                <input type="password" class="form-control" id="password-check" name="password-check" placeholder="비밀번호를 한번 더 입력하세요."/>
                <div id="pwd-success" class="mt-3 alert alert-success">비밀번호가 일치합니다.</div>
                <div id="pwd-error" class="mt-3 alert alert-danger">비밀번호가 일치하지 않습니다.</div>
            </div>

            <div class="mx-auto">
                <button type="button" id="btn-modify" class="btn btn-primary">수정</button>
                <button type="button" id="btn-cancel" class="btn btn-secondary">취소</button>
                <button type="button" id="btn-sign-out" class="btn btn-danger">탈퇴</button>
            </div>
        </form>
    </div>
</div>
<footer th:replace="~{fragments/footer::fragment-footer}"></footer>
<script th:inline="javascript" type="text/javascript">
    let pwdCheck = false;
    let loginId = $("#loginId").val();

    $("#pwd-success").hide()
    $("#pwd-error").hide()

    $("#btn-modify").attr("disabled", "disabled")

    $(document).ready(function () {
        let pwd;

        $("#btn-cancel").click(function () {
            console.log("click")
            window.location.replace("/");
        });

        $("#btn-modify").click(function () {
            if (!confirm("수정하시겠습니까?")) {
                return;
            }

            let name = $("#name").val();
            let pwd = $("#new-password").val();

            console.log("name : " + name);
            console.log("pwd : " + pwd);

            $.ajax({
                type: "PATCH",
                data: {"name":name, "password":pwd},
                url: "/member/" + loginId,

                success: function (data) {
                    console.log(data)
                    alert("회원 정보가 수정되었습니다.");

                    location.replace("/");
                },

                error: function (e) {
                    alert("통신 에러");
                    console.log(e)
                }

            });
        });

        $("#btn-sign-out").click(function () {
            if (!confirm("탈퇴하시겠습니까?")) {
                return;
            }

            $.ajax({
                type: "DELETE",
                url: "/member/" + loginId,
                data: {},
                success: function (data) {
                    alert("탈퇴하였습니다.");

                    location.replace("/");
                },
                error: function (e) {
                    console.log(e);
                }
            });
        });

        $("#password-check").focus(function () {
            pwd = $("#new-password").val();
        });

        $("#password-check").keyup(function () {
            let pwdCheck = $("#password-check").val();
            if (pwd === pwdCheck) {
                $("#pwd-error").hide();
                $("#pwd-success").show();

                $("#btn-modify").removeAttr("disabled");
            } else {
                $("#pwd-success").hide();
                $("#pwd-error").show();

                $("#btn-modify").attr("disabled", "disabled");
            }
        });
    });
</script>
</body>
</html>
