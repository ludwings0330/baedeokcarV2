<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <div th:replace="~{fragments/header::fragment-header}"></div>
  <!--    fullcalendar CDN-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales-all.min.js"></script>

</head>
<body>
<div th:replace="~{fragments/nav::fragment-nav}"></div>
<div class="content">
  <div class="container mt-3">
    <h1>차량 상세 정보</h1>
    <hr/>
기    <div id="carId" hidden th:value="${car.getId()}"></div>
    <form id="modify-form">
      <div class="row">
        <div class="col mb-3 me-5">
          <label class="form-label" for="name">차량 이름</label>
          <input id="name" name="name" class="form-control mb-3 modifiable" th:value="${car.getName()}" readonly/>
          <label for="loginId" class="form-label">차량 소유자 ID</label>
          <input id="loginId" name="loginId" class="form-control mb-3" th:value="${car.getOwner()}" readonly/>
          <label for="model" class="form-label">모델</label>
          <input id="model" name="model" class="form-control mb-3 modifiable" th:value="${car.getModel()}" readonly/>
          <label for="distance" class="form-label">주행거리</label>
          <input id="distance" name="distance" class="modifiable form-control mb-3" type="number" th:value="${car.getDistance()}" readonly/>
          <label for="price" class="form-label">일일대여요금</label>
          <input id="price" name="price" class="form-control mb-3 modifiable" type="number" th:value="${car.getPrice()}" readonly/>

        </div>
        <div class="col mb-3">
          <label>차량 사진</label>
          <img class="form-control w-100 img-thumbnail" th:src="|/images/${car.getSavedFileName()}|" th:alt="${car.getOriginFileName()}">
        </div>
      </div>
      <div class="row">
        <div class="mb-3">
          <label class="form-label">차량 소개</label>
          <textarea id="introduction" name="introduction" class="form-control modifiable" th:text="${car.getIntroduction()}" readonly></textarea>
        </div>
      </div>

      <div class="text-end">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-reservation" id="btn-reservation">예약확인</button>
        <a th:unless="${session.loginId!=car.getOwner()}" id="btn-car-mod" class="btn btn-warning px-4 owner-contents">수정</a>
        <a th:unless="${session.loginId!=car.getOwner()}" id="btn-car-mod-save" class="btn btn-success px-4 owner-contents">저장</a>
        <a th:unless="${session.loginId!=car.getOwner()}" id="btn-car-delete" class="btn btn-danger px-4 owner-contents">삭제</a>
        <a th:unless="${session.loginId!=car.getOwner()}" id="btn-car-mod-cancel" class="btn btn-primary px-4 owner-contents">취소</a>
        <a class="btn btn-secondary" href="/car">목록으로</a>
      </div>

    </form>
  </div>
</div>

<!--달력 modal-->
<div class="modal fade" id="modal-reservation">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">예약 달력</h5>
      </div>
      <div class="modal-body">
        <div id="calendar">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>


<!--예약정보 Modal -->
<div class="modal fade" id="modal-reservation-info">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">예약하기</h5>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="modal-title" class="form-label">예약명</label>
            <input type="text" class="form-control" id="modal-title" name="title">
          </div>

          <div class="mb-3">
            <label for="modal-startDate" class="form-label" >예약 시작일</label>
            <input type="text" class="form-control" id="modal-startDate" name="startDate" readonly>
          </div>

          <div class="mb-3">
            <label for="modal-endDate" class="form-label">예약 종료일</label>
            <input type="text" class="form-control" id="modal-endDate" name="endDate" readonly>
          </div>

          <div class="mb-3">
            <label for="modal-carName" class="form-label">예약 차량</label>
            <input type="text" class="form-control" id="modal-carName" name="carName" readonly>
          </div>

          <div class="mb-3">
            <label for="modal-content" class="form-label">예약 내용 메모</label>
            <textarea rows="5" class="form-control" id="modal-content" name="content"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="btn-res-save" class="btn btn-primary">예약</button>
        <button type="button" id="btn-modal-reservation-close" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<footer th:replace="~{fragments/footer::fragment-footer}"></footer>

<script th:inline="javascript">
  let loginId = [[${session.loginId}]];
  let calendar;
  toggleWhenSaveOrCancelButtonClick();

  $(document).ready(function () {
    $("#modal-reservation").on('shown.bs.modal', function () {
      let calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        height: '700px',
        initialView: 'dayGridMonth',
        locale: 'ko',
        headerToolbar: {
          start: 'prev,next today',
          center: 'title',
          end: ''
        },
        selectable: 'true',

        select: function (info) {
          console.log('start : ' + info.start);
          console.log('start STR : ' + info.startStr);
          console.log('end : ' + info.end);
          console.log('end STR : ' + info.endStr);
        //  start~end 까지 post 메세지 보낸다.
          $("#modal-reservation").modal('hide');

          setReservationSaveModalInfo(info.startStr, info.endStr);

          $("#modal-reservation-info").modal('show');
        },

        eventClick: function (info) {
          if (info.event.ExtendedProps.loginId == loginId) {
            alert("본인 이벤트 수행");
          }
          alert("event 가 클릭되었다."+info.event.id);
        }
      });

      getReservationEvents(calendar);

      calendar.render();
    });

    function requestSaveReservation(data) {

    }

    function getReservationEvents(calendar) {
      $.ajax({
        type: "GET",
        url: "/reservation/car/" + $("#carId").attr("value"),

        success: function (res) {
          for (let i = 0; i < res.length; i++) {
            calendar.addEvent({
              id: res[i].reservationId,
              title: res[i].title,
              loginId: res[i].loginId,
              carName: res[i].carName,
              carId: res[i].carId,
              content: res[i].content,
              start: res[i].startDate,
              end: res[i].endDate,
              color: "#"+Math.round(Math.random()*0xffffff).toString(16)
            })
          }
        },

        error: function (e) {
          console.log(e);
        }
      })
    }

    $("#btn-car-mod").click(function () {
      toggleWhenModButtonClick();
      enterModifyMode();
    });

    $("#btn-car-delete").click(function () {
      if (confirm("삭제하시겠습니까?")) {
        let url = "/car/"+$("#carId").attr("value");
        $.ajax({
          type: "DELETE",
          url: url,
          dataType: "text",
          success: function () {
            location.replace("/car");
          }
        });
      }
    });

    $("#btn-car-mod-save").click(function () {
      escapeModifyMode();
      toggleWhenSaveOrCancelButtonClick();

      if (confirm("수정하시겠습니까?")) {
        let url = "/car/"+$("#carId").attr("value");

        let form = $("#modify-form");
        let formData = new FormData(form[0]);

        $.ajax({
          type: "PATCH",
          url: url,
          data: formData,
          contentType: false,
          processData: false,

          success: function(data) {
            console.log("수정 완료");
          },

          error: function(e) {
            alert(e);
          }
        })
      }
    });

    $("#btn-car-mod-cancel").click(function () {
      restoreContent();
      escapeModifyMode();
      toggleWhenSaveOrCancelButtonClick();
    });

    $("#btn-res-save").click(function () {
      let data = {
        "carId"     : $("#carId").attr('value'),
        "title"     : $("#modal-title").val(),
        "content"   : $("#modal-content").val(),
        "loginId"   : loginId,
        "startDate" : $("#modal-startDate").val(),
        "endDate"   : $("#modal-endDate").val()
      };

      $.ajax({
        type: "POST",
        url: "/reservation",
        data: data,
        success: function (res) {
          $("#modal-reservation-info").modal('hide');
          removeBackdrop();
          $("#modal-reservation").modal('show');

          calendar.addEvent({
            title : $("#modal-title").val(),
            start : $("#modal-startDate").val(),
            end   : $("#modal-endDate").val(),
            color : "#"+Math.round(Math.random()*0xffffff).toString(16)
          })
        },
        error: function (e) {
          $("#modal-reservation-info").modal('hide');
          console.log(e);
        }
      })
    });

    $("#btn-modal-reservation-close").click(function () {
      $("#modal-reservation-info").hide();
      removeBackdrop();
    });
  });

  function removeBackdrop() {
    $(".modal-backdrop").remove();
  }

  function setReservationSaveModalInfo(startStr, endStr) {
    $("#modal-startDate").val(startStr);
    $("#modal-endDate").val(endStr);
    $("#modal-carName").val($("#name").val());
  }

  function toggleWhenModButtonClick() {
    $("#btn-car-mod").hide();
    $("#btn-car-delete").hide();

    $("#btn-car-mod-save").show();
    $("#btn-car-mod-cancel").show();
  }

  function toggleWhenSaveOrCancelButtonClick() {
    $("#btn-car-mod-save").hide();
    $("#btn-car-mod-cancel").hide();

    $("#btn-car-mod").show();
    $("#btn-car-delete").show();
  }

  function enterModifyMode() {
    $('.modifiable').attr("readonly", false);
  }

  function escapeModifyMode() {
    $('.modifiable').attr("readonly", true);
  }

  function restoreContent() {
    $("#name").val([[${car.getName()}]]);
    $("#model").val([[${car.getModel()}]]);
    $("#distance").val([[${car.getDistance()}]]);
    $("#price").val([[${car.getPrice()}]]);
    $("#introduction").val([[${car.getIntroduction()}]]);
  }

</script>
</body>
</html>